pipeline {
    agent {
        docker {
            image 'node:18-alpine'
        }
    }

    stages {
        stage('Checkout') {
            steps {
                echo '1. Obteniendo el código...'
                checkout scm
            }
        }
        
        stage('Install Dependencies') {
            steps {
                echo '2. Instalando dependencias (npm ci)...'
                sh 'npm ci --cache .npm' 
            }
        }
        
        stage('Run Tests (Q3 Safety Net)') {
            steps {
                echo '3. Ejecutando la red de seguridad (npm test)...'
                // Esta etapa ya no debería fallar por "skipping"
                sh 'npm test'
            }
        }
    }
    
    post {
        success {
            echo '¡Pruebas (Q3) Pasadas! El pipeline está en VERDE.'
        }
        failure {
            echo '¡FAIL FAST! Pruebas (Q3) fallaron. Build detenido.'
            // Las notificaciónes irian aquí, si tan solo las tuvieramos
        }
    }
}