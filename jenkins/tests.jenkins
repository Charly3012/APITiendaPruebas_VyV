pipeline {
    agent {
        docker {
            image 'node:22-alpine'
        }
    }

    stages {
        stage('Checkout') {
            steps {
                echo '1. Obteniendo el código...'
                checkout scm
            }
        }
        
        stage('Install Dependencies') {
            steps {
                echo '2. Instalando dependencias (npm ci)...'
                sh 'npm ci --cache .npm' 
            }
        }
        
        stage('Run Tests (Q3 Safety Net)') {
            steps {
                echo '3. Ejecutando la red de seguridad (npm test)...'
                // Esta etapa ya no debería fallar por "skipping"
                sh 'npm test'
            }
        }
    }
    
    post {
        success {        
            script {
                echo "Pruebas pasadas en la rama: ${env.BRANCH_NAME}"
        
                if (env.BRANCH_NAME == 'qa' || env.BRANCH_NAME == 'main') {
                    echo "Rama es '${env.BRANCH_NAME}'. Disparando pipeline 'Build'..."
                    
                    build job: 'APITienda_VyV_build', 
                    parameters: [string(name: 'GIT_BRANCH', value: env.BRANCH_NAME)]
                        
                } else {
                    echo "Rama es 'develop'. Fin del proceso."
                }
            }
        }
        failure {
            echo '¡FAIL FAST! Pruebas (Q3) fallaron. Build detenido.'
            // Las notificaciónes irian aquí, si tan solo las tuvieramos
        }
        
    }
}